<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Saraaaa‚ù§Ô∏è ‚Äî For You (Fixed Final)</title>
<style>
  :root{
    --bg:#fff5f6;
    --card:#fff;
    --accent:#ff7a98;
    --muted:#ffeef2;
    --text:#3b2f2f;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{
    background: linear-gradient(180deg,#fff8f9 0%, #fff2f4 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }
  .app{
    max-width:1100px;margin:20px auto;padding:18px;
    border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255, 244, 246, 0.6));
    box-shadow: 0 6px 30px rgba(245,200,220,0.25);
    min-height:85vh;
  }
  header{display:flex;align-items:center;gap:16px;padding-bottom:8px;}
  header h1{margin:0;font-size:28px;color:var(--accent);letter-spacing:0.5px}
  header .subtitle{color:#7a565e;font-size:13px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px;}
  nav button{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:10px;font-weight:600; cursor:pointer;}
  nav button.active{background:var(--accent);color:white;box-shadow:0 4px 18px rgba(255,122,152,0.15)}
  .page{display:none;padding:14px;border-radius:12px;background:var(--card);box-shadow: 0 2px 14px rgba(0,0,0,0.03);}
  .page.visible{display:block}
  .media-9-16{width:100%;max-width:420px;margin:0 auto;border-radius:14px;overflow:hidden;background:#000;aspect-ratio:9/16;display:block;}
  video.media-9-16, img.media-9-16{width:100%;height:100%;object-fit:cover;display:block;}
  #puzzle{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
  .puzzle-piece{touch-action:none;border-radius:8px;overflow:hidden;background:#ddd;cursor:grab;user-select:none;position:relative;}
  .notepad {max-width:720px;margin:0 auto;background:linear-gradient(180deg,#fff,#fffaf3);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
  textarea#note{width:100%;height:320px;border:0;outline:none;padding:12px;font-size:16px;background:linear-gradient(#fff,#fff);resize:vertical;border-radius:8px;box-shadow: inset 0 1px 0 rgba(0,0,0,0.03)}
  .small {font-size:13px;color:#8b6b6f}
  .polaroid-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px}
  .polaroid{background:#fff;padding:8px;border-radius:6px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.06);transform-origin:center;transition:transform .25s,box-shadow .25s}
  .polaroid img{width:100%;height:220px;object-fit:cover;border-radius:4px}
  .polaroid:hover{transform:translateY(-6px) rotate(-2deg);box-shadow:0 18px 40px rgba(0,0,0,0.08)}
  .timeline {max-width:820px;margin:0 auto;padding:10px}
  .timeline-card{display:flex;gap:12px;align-items:center;margin:14px 0}
  .timeline-heart{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--muted);color:var(--accent);font-weight:700;box-shadow:inset 0 -6px 12px rgba(255,122,152,0.06)}
  .timeline-text{background:linear-gradient(180deg,#fff,#fff);padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(255,130,150,0.04)}
  .row{display:flex;gap:10px;align-items:center}
  .muted{color:#8b6b6f}
  .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
  footer{margin-top:18px;text-align:center;color:#8b6b6f;font-size:13px}
  .board{display:grid;gap:8px;margin:12px auto; touch-action:none}
  .cell{display:flex;align-items:center;justify-content:center;border-radius:8px;background:linear-gradient(180deg,white,#fff7fb);font-weight:800;font-size:20px;box-shadow:0 6px 12px rgba(255,122,152,0.06);cursor:pointer;user-select:none}
  .score{display:flex;gap:10px;align-items:center}
  @media(min-width:900px){.media-9-16{max-width:320px}.polaroid img{height:260px}}
  #modal .modal-card{max-width:92%;width:420px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,#ffdbe6,#fff6f8);display:flex;align-items:center;justify-content:center;font-size:26px">üíñ</div>
    <div>
      <h1>Saraaaa ‚ù§Ô∏è</h1>
      <div class="subtitle small">A surprise ‚Äî unlock pages by playing SOS</div>
    </div>
  </header>

  <nav id="nav">
    <button data-page="game" class="active">Play (SOS)</button>
    <button data-page="video">Video & Message</button>
    <button data-page="puzzle">Mini Jigsaw</button>
    <button data-page="note">Notepad</button>
    <button data-page="timeline">Love Timeline</button>
    <button data-page="gallery">Polaroid Gallery</button>
  </nav>

  <!-- === Toggle this flag to true to hide the SOS game instantly (in code) === -->
  <!-- Also you can remove the game by commenting the "page-game" div out if you want permanent removal -->
  <script>const HIDE_GAME = false; /* set true to hide the game */</script>

  <!-- SOS Game -->
  <div id="page-game" class="page visible" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h3 style="margin:0;color:var(--accent)">Play SOS vs AI</h3>
        <div class="small muted">Win 3 consecutive rounds to unlock pages.</div>
      </div>
      <div class="score">
        <div class="small">Consecutive wins: <strong id="consec">0</strong></div>
        <div class="small">Human rounds: <strong id="humanTotal">0</strong></div>
        <div class="small">AI rounds: <strong id="aiTotal">0</strong></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="small">Board size:
        <select id="boardSize"><option value="5">5√ó5 (default)</option><option value="4">4√ó4</option><option value="6">6√ó6</option></select>
      </label>
      <label class="small" style="margin-left:10px">Turn:
        <select id="playerStarts"><option value="human">You</option><option value="ai">AI</option></select>
      </label>
      <label style="margin-left:10px" class="small">AI mistake:
        <input id="chanceMistake" type="range" min="0" max="0.9" step="0.01" value="0.35"><span id="chanceVal">0.35</span>
      </label>
      <button class="btn" id="resetScores" style="margin-left:8px">Reset</button>
    </div>

    <div id="controls" style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="small">Place letter:
        <label><input type="radio" name="letter" value="S" checked> S</label>
        <label><input type="radio" name="letter" value="O"> O</label>
      </div>
      <div class="small" style="margin-left:8px">AI chooses S/O automatically on its turn.</div>
      <button id="newGameBtn" class="btn" style="margin-left:auto">New Round</button>
    </div>

    <div id="boardWrap" style="margin-top:16px;display:flex;flex-direction:column;align-items:center">
      <div id="board" class="board" aria-label="SOS board"></div>
      <div style="margin-top:12px"><small class="muted">Tip: creating "SOS" gives points and another move.</small></div>
    </div>
  </div>
  <!-- end game -->

  <!-- Video & Message Page -->
  <div id="page-video" class="page">
    <div class="center">
      <div class="media-9-16">
        <!-- Replace src with your own 9:16 video file -->
        <video id="mainVideo" class="media-9-16" autoplay muted loop playsinline>
          <source src="/videos/video_9_16.mp4" type="video/mp4">
          <!-- fallback poster if no video available -->
          <img src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt="video poster" style="width:100%;height:100%;object-fit:cover;">
        </video>
      </div>
      <div style="margin-top:12px;max-width:720px;margin-left:auto;margin-right:auto;">
        <p style="font-size:16px;margin:8px 0">Hi <strong class="muted">Saraaaa ‚ù§Ô∏è</strong>,</p>
        <p class="small">This page holds a looping 9:16 video ‚Äî replace the video file path with yours for the real clip.</p>
      </div>
    </div>
  </div>

  <!-- Mini Jigsaw Puzzle Page -->
  <div id="page-puzzle" class="page">
    <h3 style="color:var(--accent);margin-top:0">Mini Jigsaw (9‚Äì16 pieces)</h3>
    <div class="small muted">Drag pieces to reconstruct the image (sliced tiles). Uses your 9:16 image.</div>
    <div style="margin:12px auto;max-width:420px">
      <img id="puzzleSrc" src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt="puzzle source" style="display:none">
      <div id="puzzle" aria-hidden="true"></div>
      <div style="text-align:center;margin-top:10px">
        <label>Pieces:
          <select id="pCount"><option value="9">9</option><option value="12">12</option><option value="16" selected>16</option></select>
        </label>
        <button class="btn" id="shuffleBtn">Shuffle / New</button>
      </div>
    </div>
  </div>

  <!-- Notepad Page -->
  <div id="page-note" class="page">
    <h3 style="color:var(--accent);margin-top:0">Notepad ‚Äî Write for me</h3>
    <div class="small muted">Write anything. Long text becomes scrollable. Download full text via button.</div>
    <div class="notepad">
      <input id="noteTitle" placeholder="Title (optional)" style="width:100%;padding:8px;border-radius:6px;border:1px solid #f0d9df;margin-bottom:8px" />
      <textarea id="note" placeholder="Write your message..."></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadNote">Download</button>
        <button id="clearNote" style="background:#fff;border:1px solid #ffd3dd;padding:8px 10px;border-radius:8px">Clear</button>
        <div class="small muted" style="margin-left:auto">Size: <span id="noteSize">0</span> chars</div>
      </div>
    </div>
  </div>

  <!-- Love Timeline Page -->
  <div id="page-timeline" class="page">
    <h3 style="color:var(--accent);margin-top:0">Love Timeline</h3>
    <div class="small muted">Milestones & memories. Use 9:16 images if you add photos here.</div>
    <div class="timeline" id="timeline">
      <div style="margin:8px auto;max-width:360px;border-radius:12px;overflow:hidden">
        <img src="/mnt/data/6fe45b40-5b37-445e-b562-10ee0e21e681.png" style="width:100%;height:360px;object-fit:cover;border-radius:12px" alt="timeline">
      </div>
      <div class="timeline-card"><div class="timeline-heart">01</div><div class="timeline-text"><strong>First time to meet</strong><div class="muted small">Date: 2009.01.07</div></div></div>
      <div class="timeline-card"><div class="timeline-heart">02</div><div class="timeline-text"><strong>First date</strong><div class="muted small">Date: 2009.01.25</div></div></div>
      <div class="timeline-card"><div class="timeline-heart">03</div><div class="timeline-text"><strong>First kiss</strong><div class="muted small">Date: 2009.06.15</div></div></div>
      <div style="text-align:center;margin-top:8px"><button class="btn" id="addMilestone">Add milestone (demo)</button></div>
    </div>
  </div>

  <!-- Polaroid Gallery Page -->
  <div id="page-gallery" class="page">
    <h3 style="color:var(--accent);margin-top:0">Polaroid Gallery</h3>
    <div class="small muted">Tap a photo to enlarge ‚Äî all images shown in polaroid frames (9:16).</div>
    <div style="margin-top:12px" class="polaroid-grid" id="polaroidGrid">
      <!-- Use your local 9:16 images here -->
      <div class="polaroid"><img src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt=""><div class="small muted">Us</div></div>
      <div class="polaroid"><img src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt=""><div class="small muted">Memory</div></div>
      <div class="polaroid"><img src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt=""><div class="small muted">Moments</div></div>
      <div class="polaroid"><img src="/mnt/data/f2725155-ccc1-4b7c-afc3-661219a0f45e.png" alt=""><div class="small muted">Smile</div></div>
    </div>
  </div>

  <footer>Made with care üíñ ‚Äî All media set to 9:16 for mobile-friendly look.</footer>
</div>

<!-- Modal -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:9999">
  <div class="modal-card" style="background:white;padding:18px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.35)">
    <div id="modalMsg" style="font-size:18px;color:var(--accent);font-weight:800"></div>
    <div style="margin-top:10px"><button class="btn" id="modalClose">Close</button></div>
  </div>
</div>

<script>
/* ===========================
   Configuration
   =========================== */
const CHANCE_TO_MISTAKE_DEFAULT = 0.35;
let CHANCE_TO_MISTAKE = CHANCE_TO_MISTAKE_DEFAULT;

/* Optionally hide game immediately (in runtime) using HIDE_GAME var declared in <script> earlier */
try {
  if(typeof HIDE_GAME !== 'undefined' && HIDE_GAME){
    const g = document.getElementById('page-game');
    if(g) g.remove();
  }
} catch(e){ console.warn(e); }

/* ===========================
   Helpers: localStorage safe wrapper
   =========================== */
const storage = {
  get(key, fallback=0){
    try{ const v = localStorage.getItem(key); return v===null?fallback:JSON.parse(v); }catch(e){ return fallback; }
  },
  set(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
  },
  remove(key){ try{ localStorage.removeItem(key);}catch(e){} }
};

/* ===========================
   Page Navigation
   =========================== */
const nav = document.getElementById('nav');
const pages = {
  game: document.getElementById('page-game'),
  video: document.getElementById('page-video'),
  puzzle: document.getElementById('page-puzzle'),
  note: document.getElementById('page-note'),
  timeline: document.getElementById('page-timeline'),
  gallery: document.getElementById('page-gallery')
};
nav.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const key = btn.dataset.page;
  if(!key) return;
  // if game exists and not unlocked, block other pages
  if(pages.game && !isUnlocked() && key !== 'game'){
    alert('Win 3 consecutive rounds to unlock the pages. Good luck!');
    return;
  }
  nav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  Object.values(pages).forEach(p=>p && p.classList.remove('visible'));
  if(pages[key]) pages[key].classList.add('visible');
});

/* ===========================
   Modal helpers
   =========================== */
const modal = document.getElementById('modal');
const modalMsg = document.getElementById('modalMsg');
const modalCloseBtn = document.getElementById('modalClose');
function showModal(msg, allowClose=true){
  modalMsg.innerHTML = msg;
  modal.style.display = 'flex';
  modalCloseBtn.style.display = allowClose? 'inline-block' : 'none';
}
function hideModal(){ modal.style.display = 'none'; }
modalCloseBtn.addEventListener('click', hideModal);
modal.addEventListener('click', (e)=>{ if(e.target === modal) hideModal(); });

/* ===========================
   Unlock system helpers
   =========================== */
function getConsecutive(){ return Number(storage.get('sara_consec', 0)); }
function setConsecutive(v){ storage.set('sara_consec', v); const el=document.getElementById('consec'); if(el) el.textContent = v; }
function getTotals(){ return { human: Number(storage.get('sara_human', 0)), ai: Number(storage.get('sara_ai', 0)) }; }
function setTotals(h, a){ storage.set('sara_human', h); storage.set('sara_ai', a); const ht=document.getElementById('humanTotal'); const at=document.getElementById('aiTotal'); if(ht) ht.textContent = h; if(at) at.textContent = a; }
function isUnlocked(){ return getConsecutive() >= 3; }
function unlockAllPages(){
  // hide game UI if present
  const gameEl = document.getElementById('page-game');
  if(gameEl) gameEl.style.display = 'none';
  showModal('All pages unlocked! ‚ù§Ô∏è', true);
  // set nav active to video
  nav.querySelectorAll('button').forEach(b=>{ if(b.dataset.page === 'video') b.classList.add('active'); else b.classList.remove('active'); });
  Object.values(pages).forEach(p=>p && p.classList.remove('visible'));
  if(pages.video) pages.video.classList.add('visible');
}

/* Initialize UI totals */
const totals = getTotals(); setTotals(totals.human, totals.ai);
document.getElementById('consec').textContent = getConsecutive();

/* ===========================
   SOS Game implementation
   =========================== */
let boardSize = 5;
let board = [];
let humanScore = 0, aiScore = 0;
let currentPlayer = 'human';
const boardEl = document.getElementById('board');
const boardSizeSelect = document.getElementById('boardSize');
const playerStarts = document.getElementById('playerStarts');
const chanceRange = document.getElementById('chanceMistake');
const chanceVal = document.getElementById('chanceVal');

boardSizeSelect.addEventListener('change', ()=>{ boardSize = Number(boardSizeSelect.value); buildBoard(); });
chanceRange.addEventListener('input', ()=>{ CHANCE_TO_MISTAKE = Number(chanceRange.value); chanceVal.textContent = CHANCE_TO_MISTAKE.toFixed(2); });
chanceRange.value = CHANCE_TO_MISTAKE_DEFAULT; chanceVal.textContent = CHANCE_TO_MISTAKE_DEFAULT.toFixed(2); CHANCE_TO_MISTAKE = CHANCE_TO_MISTAKE_DEFAULT;

document.getElementById('resetScores').addEventListener('click', ()=>{
  if(!confirm('Reset rounds and consecutive wins?')) return;
  storage.remove('sara_consec'); storage.remove('sara_human'); storage.remove('sara_ai');
  setConsecutive(0); setTotals(0,0);
  humanScore = aiScore = 0; buildBoard();
});

/* board helpers */
function inb(r,c){ return r>=0 && c>=0 && r<board.length && c<board.length; }
function countSOS(board, r, c){
  const ch = board[r][c];
  if(!ch) return 0;
  const dirs = [[0,1],[1,0],[1,1],[1,-1]];
  let cnt = 0;
  for(const [dr,dc] of dirs){
    if(ch === 'O'){
      const r1=r-dr, c1=c-dc, r2=r+dr, c2=c+dc;
      if(inb(r1,c1) && inb(r2,c2) && board[r1][c1]==='S' && board[r2][c2]==='S') cnt++;
    } else {
      const r1=r+dr, c1=c+dc, r2=r+2*dr, c2=c+2*dc;
      if(inb(r1,c1) && inb(r2,c2) && board[r1][c1]==='O' && board[r2][c2]==='S') cnt++;
      const r3=r-dr, c3=c-dc, r4=r-2*dr, c4=c-2*dc;
      if(inb(r3,c3) && inb(r4,c4) && board[r3][c3]==='O' && board[r4][c4]==='S') cnt++;
    }
  }
  return cnt;
}
function emptyCells(b){
  const res=[]; for(let r=0;r<b.length;r++) for(let c=0;c<b.length;c++) if(!b[r][c]) res.push([r,c]); return res;
}
function copyBoard(b){ return b.map(row=>row.slice()); }

function evaluateBoardForPlayer(board, letter){
  // simple heuristic: favor positions where this player's letters create SOS
  let score = 0;
  for(let r=0;r<board.length;r++) for(let c=0;c<board.length;c++){
    if(board[r][c]){
      if(board[r][c] === letter) score += countSOS(board,r,c);
      else score -= countSOS(board,r,c)*0.4;
    }
  }
  return score;
}

function aiChooseMove(b){
  const empties = emptyCells(b);
  if(!empties.length) return null;
  const moves = [];
  for(const [r,c] of empties){
    for(const letter of ['S','O']){
      const nb = copyBoard(b);
      nb[r][c] = letter;
      const immediate = countSOS(nb,r,c);
      const evalScore = evaluateBoardForPlayer(nb, letter);
      moves.push({r,c,letter,score: immediate + 0.01*evalScore});
    }
  }
  moves.sort((a,b)=>b.score - a.score);
  if(Math.random() < CHANCE_TO_MISTAKE){
    const top = Math.max(1, Math.floor(moves.length * 0.35));
    return moves[Math.floor(Math.random()*top)];
  }
  return moves[0];
}

/* build board UI */
function buildBoard(){
  boardSize = Number(boardSizeSelect.value || 5);
  board = Array.from({length:boardSize}, ()=>Array.from({length:boardSize}, ()=>''));
  boardEl.style.gridTemplateColumns = `repeat(${boardSize}, minmax(40px, ${Math.floor(420/boardSize)}px))`;
  boardEl.style.width = `${Math.min(420, boardSize*80)}px`;
  boardEl.innerHTML = '';
  for(let r=0;r<boardSize;r++){
    for(let c=0;c<boardSize;c++){
      const el = document.createElement('div');
      el.className = 'cell';
      el.style.minHeight = `${Math.floor(420/boardSize)}px`;
      el.dataset.r = r; el.dataset.c = c;
      el.addEventListener('click', onCellClick);
      el.textContent = '';
      boardEl.appendChild(el);
    }
  }
  humanScore = aiScore = 0;
  // if AI starts, let it move after short delay
  currentPlayer = playerStarts.value === 'human' ? 'human' : 'ai';
  if(currentPlayer === 'ai') setTimeout(()=>aiPlay(), 350);
}
function updateTotalsDisplay(){
  const t = getTotals(); setTotals(t.human, t.ai);
}
function onCellClick(e){
  const r = Number(e.currentTarget.dataset.r), c = Number(e.currentTarget.dataset.c);
  if(board[r][c]) return;
  if(currentPlayer !== 'human') return;
  const letter = document.querySelector('input[name="letter"]:checked').value;
  placeLetter(r,c,letter,'human');
}
function placeLetter(r,c,letter,who){
  if(board[r][c]) return;
  board[r][c] = letter;
  const idx = r*boardSize + c;
  const cell = boardEl.children[idx];
  if(cell) cell.textContent = letter;
  const formed = countSOS(board,r,c);
  if(who === 'human') humanScore += formed; else aiScore += formed;
  if(formed > 0){
    showTempMessage(`${who==='human'?'You':'AI'} formed ${formed} SOS${formed>1?'es':''}`);
    if(emptyCells(board).length === 0) finalizeRound();
    else if(who === 'ai') setTimeout(()=>aiPlay(), 350);
    // if human formed, they keep turn (no change)
  } else {
    currentPlayer = (who === 'human') ? 'ai' : 'human';
    if(currentPlayer === 'ai') setTimeout(()=>aiPlay(), 350);
  }
}

function aiPlay(){
  const move = aiChooseMove(board);
  if(!move){ finalizeRound(); return; }
  placeLetter(move.r, move.c, move.letter, 'ai');
}

function finalizeRound(){
  const h = humanScore, a = aiScore;
  let totals = getTotals();
  if(h > a){
    totals.human += 1;
    storage.set('sara_human', totals.human);
    setConsecutive(getConsecutive() + 1);
    setTotals(totals.human, totals.ai);
    showModal('You won this round! üíñ', true);
  } else if(a > h){
    totals.ai += 1;
    storage.set('sara_ai', totals.ai);
    setConsecutive(0);
    setTotals(totals.human, totals.ai);
    showModal('AI won this round. Try again!', true);
  } else {
    setConsecutive(0);
    showModal('Round tied. Try again!', true);
  }
  // unlock check
  if(isUnlocked()) { unlockAllPages(); return; }
  // reset board for next round
  humanScore = aiScore = 0;
  board = Array.from({length:boardSize}, ()=>Array.from({length:boardSize}, ()=>''));
  setTimeout(buildBoard, 400);
}

/* quick temporary modal message */
function showTempMessage(msg){
  modalMsg.textContent = msg; modal.style.display = 'flex';
  setTimeout(()=>{ if(modal.style.display === 'flex') modal.style.display = 'none'; }, 900);
}

document.getElementById('newGameBtn').addEventListener('click', ()=>{
  humanScore = aiScore = 0;
  setConsecutive(0);
  buildBoard();
});

/* initialize board */
buildBoard();
updateTotalsDisplay();

/* ===========================
   Puzzle (slicing + drag + swap)
   =========================== */
const puzzleImg = document.getElementById('puzzleSrc');
const puzzleContainer = document.getElementById('puzzle');
const shuffleBtn = document.getElementById('shuffleBtn');
const pCountSelect = document.getElementById('pCount');

function createPuzzle(){
  const pieces = Number(pCountSelect.value || 16);
  const cols = Math.ceil(Math.sqrt(pieces));
  const rows = Math.ceil(pieces / cols);
  const img = puzzleImg;
  if(!img.complete || img.naturalWidth === 0){ img.onload = createPuzzle; return; }
  const iw = img.naturalWidth, ih = img.naturalHeight;
  const pieceW = Math.floor(iw/cols), pieceH = Math.floor(ih/rows);
  const piecesArr = [];
  let idx = 0;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const canvas = document.createElement('canvas'); canvas.width = pieceW; canvas.height = pieceH;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, c*pieceW, r*pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);
      const data = canvas.toDataURL();
      piecesArr.push({data, origIndex: idx});
      idx++;
    }
  }
  // shuffle visual array
  const visual = piecesArr.slice(); shuffleArray(visual);
  puzzleContainer.innerHTML = '';
  for(const p of visual){
    const el = document.createElement('div'); el.className = 'puzzle-piece';
    el.style.flex = `0 0 calc(${100/cols}% - 6px)`; el.style.minHeight = `${Math.floor(420/rows)}px`;
    const i = document.createElement('img'); i.draggable = false; i.src = p.data; i.style.width='100%'; i.style.height='100%'; i.style.objectFit='cover';
    el.appendChild(i);
    el.dataset.origIndex = p.origIndex;
    // pointer handlers
    el.addEventListener('pointerdown', puzzlePointerDown);
    puzzleContainer.appendChild(el);
  }
  checkPuzzleSolved();
}
function puzzlePointerDown(e){
  e.preventDefault();
  const el = e.currentTarget; el.setPointerCapture(e.pointerId);
  el.style.zIndex = 1000; el.style.transition = 'none';
  const startX = e.clientX, startY = e.clientY;
  function move(evt){ el.style.transform = `translate(${evt.clientX - startX}px, ${evt.clientY - startY}px)`; }
  function up(evt){
    el.releasePointerCapture(e.pointerId);
    el.style.transform = ''; el.style.zIndex = '';
    // find nearest piece
    const all = Array.from(document.querySelectorAll('.puzzle-piece'));
    let nearest=null, dmin=Infinity;
    for(const a of all){
      if(a===el) continue;
      const r = a.getBoundingClientRect();
      const dx = (r.left + r.width/2) - evt.clientX;
      const dy = (r.top + r.height/2) - evt.clientY;
      const d = Math.hypot(dx,dy);
      if(d<dmin){ dmin=d; nearest=a; }
    }
    if(nearest && dmin < 120){
      // swap: replace positions in DOM
      const parent = puzzleContainer;
      const elNext = el.nextSibling;
      parent.insertBefore(el, nearest);
      if(elNext) parent.insertBefore(nearest, elNext); else parent.appendChild(nearest);
    }
    el.removeEventListener('pointermove', move);
    window.removeEventListener('pointerup', up);
    checkPuzzleSolved();
  }
  el.addEventListener('pointermove', move);
  window.addEventListener('pointerup', up);
}
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
shuffleBtn.addEventListener('click', createPuzzle);
pCountSelect.addEventListener('change', createPuzzle);
if(puzzleImg.complete) createPuzzle(); else puzzleImg.onload = createPuzzle;

function checkPuzzleSolved(){
  const parts = Array.from(document.querySelectorAll('#puzzle .puzzle-piece'));
  if(parts.length===0) return;
  let solved = true;
  for(let i=0;i<parts.length;i++){
    const idx = Number(parts[i].dataset.origIndex);
    if(idx !== i){ solved = false; break; }
  }
  if(solved){
    showModal('Puzzle solved! Beautiful ‚ù§Ô∏è', true);
  }
}

/* ===========================
   Notepad download
   =========================== */
const noteEl = document.getElementById('note');
const titleEl = document.getElementById('noteTitle');
const noteSizeEl = document.getElementById('noteSize');
noteEl.addEventListener('input', ()=> noteSizeEl.textContent = noteEl.value.length);
document.getElementById('downloadNote').addEventListener('click', ()=>{
  const text = (titleEl.value ? titleEl.value + '\n\n' : '') + noteEl.value;
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (titleEl.value?slugify(titleEl.value):'message') + '.txt';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('clearNote').addEventListener('click', ()=>{ if(confirm('Clear note?')) noteEl.value=''; noteSizeEl.textContent = noteEl.value.length; });
function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

/* ===========================
   Timeline add demo
   =========================== */
document.getElementById('addMilestone').addEventListener('click', ()=>{
  const t = prompt('Enter milestone (e.g., "Our roadtrip - 2023.04.01")'); if(!t) return;
  const container = document.getElementById('timeline');
  const idx = container.querySelectorAll('.timeline-card').length + 1;
  const el = document.createElement('div'); el.className='timeline-card';
  el.innerHTML = `<div class="timeline-heart">${String(idx).padStart(2,'0')}</div><div class="timeline-text"><strong>${escapeHtml(t)}</strong></div>`;
  container.appendChild(el);
});
function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ===========================
   Polaroid enlarge
   =========================== */
document.getElementById('polaroidGrid').addEventListener('click', (e)=>{
  const p = e.target.closest('.polaroid'); if(!p) return;
  const img = p.querySelector('img').src;
  modalMsg.innerHTML = `<div style="max-width:420px"><img src="${img}" style="width:100%;border-radius:10px"></div>`;
  modal.style.display = 'flex';
});

/* ===========================
   Initialize totals & consec display
   =========================== */
document.getElementById('consec').textContent = getConsecutive();
updateTotalsDisplay();

</script>
</body>
</html>
