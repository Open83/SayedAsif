<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Saraaa ❤️ — For You</title>

<!-- Handwritten font for Notepad (Google Fonts) -->
<link href="https://fonts.googleapis.com/css2?family=Nothing+You+Could+Do&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#071026; --accent:#ff6b9a; --muted:#9aa6b2; --glass:rgba(255,255,255,0.03);
    --max-w:420px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071026,#041023);color:#eaf2ff}
  .app{display:flex;flex-direction:column;align-items:center;padding:12px;min-height:100vh;box-sizing:border-box}
  header{width:100%;max-width:var(--max-w);display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  h1{margin:0;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--glass);border-radius:12px;padding:8px 10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:inherit}
  .frame{width:100%;max-width:380px;aspect-ratio:9/16;border-radius:16px;background:linear-gradient(180deg,#081226,#051224);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .page{position:absolute;inset:0;padding:12px;box-sizing:border-box;display:none;flex-direction:column;gap:8px;overflow:auto;-webkit-overflow-scrolling:touch}
  .page.active{display:flex}
  video.player{width:100%;height:auto;border-radius:12px;object-fit:cover;background:#000}
  /* Unlock overlay */
  #unlock-screen{position:absolute;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.92),rgba(2,6,23,0.85));z-index:50;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:10px;border-radius:16px}
  #unlock-screen.hide{display:none}
  #statusBox{position:absolute;right:10px;top:10px;background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:10px;font-size:12px;color:var(--muted);z-index:90}
  #logBox{position:absolute;left:10px;top:10px;background:rgba(0,0,0,0.36);padding:6px 8px;border-radius:10px;font-size:12px;color:var(--muted);z-index:90;max-width:40%;max-height:26vh;overflow:auto}
  .dbg-line{font-size:11px;color:#cdd9e6;margin-top:2px}
  /* Games layout */
  .game-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:10px;border-radius:12px}
  .jigsaw-board{position:relative;width:100%;height:60vmin;max-height:58%;background:#041022;border-radius:12px;overflow:hidden;touch-action:none}
  .j-piece{position:absolute;background-size:cover;background-repeat:no-repeat;border-radius:6px;transition:transform .12s;box-shadow:0 6px 18px rgba(0,0,0,0.5);touch-action:none}
  canvas{width:100%;height:100%;display:block;border-radius:12px}
  .polaroid-grid{display:flex;flex-wrap:wrap;gap:8px;padding:4px;justify-content:center}
  .polaroid{width:48%;aspect-ratio:9/16;background:#000;border-radius:10px;overflow:hidden;transform:rotate(-6deg);box-shadow:0 10px 24px rgba(0,0,0,0.6);border:8px solid #fff;touch-action:manipulation}
  .polaroid img{width:100%;height:100%;object-fit:cover;display:block}
  .polaroid.big{width:96%;aspect-ratio:9/5;transform:none;z-index:100}
  .note-hand{font-family:'Nothing You Could Do', cursive;font-size:16px;line-height:1.4;color:#fff;background:linear-gradient(180deg,#011221,#021426);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  textarea.note{width:100%;min-height:36vmin;border-radius:12px;padding:12px;background:transparent;border:0;color:#fff;font-size:16px;resize:none;font-family:inherit}
  footer{margin-top:10px;font-size:12px;color:var(--muted);text-align:center}
  @media(min-width:520px){ .frame{max-width:420px} .polaroid{width:30%} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Saraaa ❤️</h1>
      <div class="sub">A little world — made for you</div>
    </div>
    <nav id="nav">
      <button class="btn" data-page="welcome">Welcome</button>
      <button class="btn" data-page="games">Games</button>
      <button class="btn" data-page="timeline">Timeline</button>
      <button class="btn" data-page="gallery">Gallery</button>
      <button class="btn" data-page="notepad">Notepad</button>
    </nav>
  </header>

  <main class="frame" id="frame">
    <div id="statusBox">LOCKED • Wins: <span id="statusWins">0</span>/<span id="statusReq">3</span></div>
    <div id="logBox"><strong>LOG</strong><div id="logLines"></div></div>

    <!-- Unlock overlay -->
    <div id="unlock-screen">
      <div style="font-size:18px">Unlock the site — Play SOS to open the pages</div>
      <div style="color:var(--muted)">Consecutive wins required: <strong id="winsNeeded">3</strong></div>
      <div style="color:var(--muted)">You need <span id="winsRemaining">3</span> more consecutive wins</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="startSOS">Start SOS Game</button>
        <button class="btn" id="resetSOS">Reset</button>
      </div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Developer shortcut: include the HTML comment <code>&lt;!-- hide-game --&gt;</code> anywhere in the file to bypass the lock.</div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">AI mistake chance: <span id="mistakeVal"></span></div>
    </div>

    <!-- SOS container (in-frame overlay for matches) -->
    <div class="sos-ui" id="sosUI" style="display:none;z-index:70;"></div>

    <!-- Page 1: Welcome with 9:16 video -->
    <section id="welcome" class="page active">
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px">
        <video id="welcomeVideo" class="player" playsinline muted loop autoplay>
          <source src="video-9x16.mp4" type="video/mp4">
          <!-- If you don't have the video, the rest still works -->
        </video>
        <div style="text-align:center">
          <strong>For Saraaa ❤️</strong>
          <div style="font-size:13px;color:var(--muted)">Made with love — tap Games to start the surprise.</div>
        </div>
      </div>
    </section>

    <!-- Page 2: Games (3 mini-games) -->
    <section id="games" class="page">
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="game-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Mini Jigsaw</div>
            <div style="font-size:12px;color:var(--muted)">Upload a 9:16 image</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="jigsawFile" type="file" accept="image/*" />
            <select id="piecesCount">
              <option value="9">9</option>
              <option value="12">12</option>
              <option value="16" selected>16</option>
            </select>
            <button id="startJigsaw" class="btn">Start</button>
          </div>
          <div id="jigsawBoard" class="jigsaw-board" style="margin-top:8px;display:none"></div>
          <div id="jigsawMsg" style="font-size:13px;color:var(--muted);margin-top:6px"></div>
        </div>

        <div class="game-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Heart Maze</div>
            <div style="font-size:12px;color:var(--muted)">Swipe or tilt to guide the dot</div>
          </div>
          <div id="mazeWrap" class="jigsaw-board" style="margin-top:8px">
            <canvas id="mazeCanvas"></canvas>
            <div id="playerDot" style="position:absolute;left:12%;top:70%;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;font-weight:700;box-shadow:0 8px 26px rgba(255,107,154,0.18)">❤</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="resetMaze" class="btn">Reset</button>
            <div id="mazeMsg" style="font-size:13px;color:var(--muted)"></div>
          </div>
        </div>

        <div class="game-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Connect Hearts (Dot-to-Dot)</div>
            <div style="font-size:12px;color:var(--muted)">Touch to join numbered dots</div>
          </div>
          <canvas id="connectCanvas" style="margin-top:8px;height:44vmin;background:#041429;border-radius:10px"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="resetConnect" class="btn">Reset</button>
            <div id="connectMsg" style="font-size:13px;color:var(--muted)"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Page 3: Love Timeline -->
    <section id="timeline" class="page">
      <div style="font-weight:700">Love Timeline</div>
      <div id="timelineList" style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
        <!-- sample milestones -->
        <div style="display:flex;gap:10px;align-items:flex-start">
          <div style="width:14px;height:14px;border-radius:50%;background:var(--accent);margin-top:8px"></div>
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:10px">
            <div style="font-weight:700">First Chat</div>
            <div style="font-size:13px;color:var(--muted)">That day we started talking — unforgettable</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-start;flex-direction:row-reverse">
          <div style="width:14px;height:14px;border-radius:50%;background:var(--accent);margin-top:8px"></div>
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:10px">
            <div style="font-weight:700">Movie Night</div>
            <div style="font-size:13px;color:var(--muted)">Popcorn & talk till late</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-start">
          <div style="width:14px;height:14px;border-radius:50%;background:var(--accent);margin-top:8px"></div>
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:10px">
            <div style="font-weight:700">Your Smile</div>
            <div style="font-size:13px;color:var(--muted)">Still my favorite view</div>
            <div style="margin-top:6px"><input id="tlImageInput" type="file" accept="image/*" /></div>
          </div>
        </div>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">Tip: upload 9:16 images for milestones using the file input.</div>
    </section>

    <!-- Page 4: Polaroid Gallery -->
    <section id="gallery" class="page">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Polaroid Gallery</div>
        <div style="font-size:12px;color:var(--muted)">Tap to enlarge</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="galleryFiles" type="file" accept="image/*" multiple />
        <button id="clearGallery" class="btn">Clear</button>
      </div>
      <div class="polaroid-grid" id="polaroidGrid" style="margin-top:8px"></div>
    </section>

    <!-- Page 5: Notepad -->
    <section id="notepad" class="page">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Notepad</div>
        <div style="font-size:12px;color:var(--muted)">Handwritten style & .txt download</div>
      </div>
      <div class="note-hand" style="display:flex;flex-direction:column;gap:8px;height:100%">
        <textarea id="noteArea" class="note" placeholder="Write your message... (long messages supported)"></textarea>
        <div style="display:flex;gap:8px">
          <input id="nameForFile" placeholder="note.txt" style="flex:1;padding:8px;border-radius:8px;background:#021426;border:1px solid rgba(255,255,255,0.02);color:#fff" />
          <button id="downloadNote" class="btn">Download .txt</button>
        </div>
      </div>
    </section>

  </main>

  <footer>Made with ♥ for Saraaa — Mobile-friendly • 9:16 media</footer>
</div>

<script>
/* ===========================
   Configuration & utilities
   =========================== */
const CHANCE_TO_MISTAKE = 0.35; // adjustable
const WINS_REQUIRED = 3;
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function log(msg){
  try{
    const ln = document.createElement('div'); ln.className='dbg-line'; ln.textContent = (new Date()).toLocaleTimeString() + ' — ' + msg;
    const box = document.getElementById('logLines'); box.prepend(ln);
    while(box.children.length > 24) box.removeChild(box.lastChild);
    console.log('[SARA]', msg);
  }catch(e){ console.error(e) }
}

/* show AI chance & requirements */
document.getElementById('mistakeVal').innerText = (CHANCE_TO_MISTAKE*100).toFixed(0) + '%';
document.getElementById('winsNeeded').innerText = WINS_REQUIRED;
document.getElementById('statusReq').innerText = WINS_REQUIRED;

/* robust developer bypass detection (comment node walker) */
function hasHideGameComment(){
  try{
    const walker = document.createTreeWalker(document, NodeFilter.SHOW_COMMENT, null, false);
    let n; while(n = walker.nextNode()){
      if(typeof n.nodeValue === 'string' && n.nodeValue.includes('hide-game')) return true;
    }
  }catch(e){ return false; }
  return false;
}
const DEV_BYPASS = hasHideGameComment();
if(DEV_BYPASS){
  $('#unlock-screen').classList.add('hide');
  $('#statusBox').textContent = 'BYPASS ACTIVE — UNLOCKED';
  log('hide-game comment found (bypass enabled)');
} else {
  log('No hide-game comment found — site locked until SOS unlocked');
}

/* Navigation: prevent protected pages while locked */
function showPage(id){
  $$('.page').forEach(p => p.classList.remove('active'));
  const page = document.getElementById(id);
  if(page) page.classList.add('active');
}
$('#nav').addEventListener('click', e=>{
  const b = e.target.closest('button[data-page]');
  if(!b) return;
  const id = b.dataset.page;
  const protectedPages = ['games','timeline','gallery','notepad'];
  if(!DEV_BYPASS && !$('#unlock-screen').classList.contains('hide') && protectedPages.includes(id)){
    alert('Please unlock the site first by winning SOS 3 times in a row.');
    log('Blocked navigation to ' + id + ' while locked');
    return;
  }
  showPage(id); log('Navigated to ' + id);
});

/* Unlock state variables */
let consecutiveWins = 0;
let winsRemaining = WINS_REQUIRED;
function updateWinsUI(){
  document.getElementById('winsRemaining').innerText = winsRemaining;
  document.getElementById('statusWins').innerText = consecutiveWins;
}
updateWinsUI();

/* Expose createSOS for debug */
window.createSOS = createSOS;

/* =========================
   SOS Game (5x5) w/ AI
   ========================= */
function createSOS(){
  try{
    const sosUI = document.getElementById('sosUI');
    sosUI.innerHTML = '';
    sosUI.style.display = 'flex';
    sosUI.classList.add('show');

    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent='SOS — Unlock Game';
    const info = document.createElement('div'); info.style.fontSize='12px'; info.style.color='#9aa6b2'; info.textContent='Pick S or O then tap a cell.';
    sosUI.appendChild(title); sosUI.appendChild(info);

    const top = document.createElement('div'); top.style.display='flex'; top.style.gap='6px';
    const btnS = document.createElement('button'); btnS.className='btn'; btnS.textContent='S';
    const btnO = document.createElement('button'); btnO.className='btn'; btnO.textContent='O';
    const status = document.createElement('div'); status.style.flex='1'; status.style.textAlign='center'; status.style.color='#ffd1e0';
    top.appendChild(btnS); top.appendChild(btnO); top.appendChild(status);
    sosUI.appendChild(top);

    const SIZE = 5;
    const gridWrap = document.createElement('div'); gridWrap.style.display='grid'; gridWrap.style.gridTemplateColumns = `repeat(${SIZE},1fr)`; gridWrap.style.gap='6px'; gridWrap.style.marginTop='8px';
    sosUI.appendChild(gridWrap);

    const cells = [];
    for(let r=0;r<SIZE;r++){
      for(let c=0;c<SIZE;c++){
        const cell = document.createElement('button');
        cell.className = 'btn';
        cell.dataset.r = r; cell.dataset.c = c;
        cell.style.minHeight = '46px';
        gridWrap.appendChild(cell);
        cells.push(cell);
      }
    }

    const ctrl = document.createElement('div'); ctrl.style.display='flex'; ctrl.style.justifyContent='space-between'; ctrl.style.marginTop='8px';
    const restart = document.createElement('button'); restart.className='btn'; restart.textContent='Restart Match';
    const close = document.createElement('button'); close.className='btn'; close.textContent='Close';
    ctrl.appendChild(restart); ctrl.appendChild(close); sosUI.appendChild(ctrl);

    // state
    let board = Array.from({length:SIZE},()=>Array(SIZE).fill(''));
    let playerLetter = 'S';
    let turn = 'player';
    let scores = {player:0,ai:0};

    function totalSOS(bd){
      let total=0;
      const dirs = [[0,1],[1,0],[1,1],[1,-1]];
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          for(const [dr,dc] of dirs){
            const r2=r+dr, c2=c+dc, r3=r+dr*2, c3=c+dc*2;
            if(r3<0||c3<0||r3>=SIZE||c3>=SIZE) continue;
            if(bd[r][c]==='S' && bd[r2][c2]==='O' && bd[r3][c3]==='S') total++;
          }
        }
      }
      return total;
    }

    function render(){
      cells.forEach(btn=>{
        const r = +btn.dataset.r, c = +btn.dataset.c;
        btn.innerText = board[r][c] || '';
        btn.disabled = !!board[r][c];
      });
      status.innerText = `Turn: ${turn.toUpperCase()} • You:${scores.player} AI:${scores.ai}`;
    }

    function cloneBoard(bd){ return bd.map(r=>r.slice()); }
    function availableMoves(bd){ const list=[]; for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(!bd[r][c]){ list.push({r,c,letter:'S'}); list.push({r,c,letter:'O'}); } return list; }

    function minimax(bd, depth, maximizing){
      if(depth===0 || bd.flat().every(x=>x)) return totalSOS(bd);
      const moves = availableMoves(bd);
      if(maximizing){
        let best=-Infinity;
        for(const m of moves){ const nb = cloneBoard(bd); nb[m.r][m.c]=m.letter; const val = minimax(nb, depth-1, false); if(val>best) best=val; }
        return best;
      } else {
        let best=Infinity;
        for(const m of moves){ const nb = cloneBoard(bd); nb[m.r][m.c]=m.letter; const val = minimax(nb, depth-1, true); if(val<best) best=val; }
        return best;
      }
    }

    function aiChooseMove(){
      const moves = availableMoves(board);
      if(moves.length===0) return null;
      const scored = moves.map(m => { const nb = cloneBoard(board); nb[m.r][m.c]=m.letter; return {m, val: minimax(nb, 3, false)}; });
      scored.sort((a,b)=>b.val-a.val);
      if(Math.random() < CHANCE_TO_MISTAKE && scored.length>1){
        const topN = Math.min(3, scored.length);
        return scored[Math.floor(Math.random()*topN)].m;
      }
      return scored[0].m;
    }

    // events
    btnS.onclick = ()=>{ playerLetter='S'; btnS.style.background='linear-gradient(90deg,#ff9fbf,#ff6b9a)'; btnO.style.background=''; };
    btnO.onclick = ()=>{ playerLetter='O'; btnO.style.background='linear-gradient(90deg,#ff9fbf,#ff6b9a)'; btnS.style.background=''; };

    gridWrap.addEventListener('click', e=>{
      const cell = e.target.closest('button');
      if(!cell) return;
      const r = +cell.dataset.r, c = +cell.dataset.c;
      if(board[r][c] || turn !== 'player') return;
      const before = totalSOS(board);
      board[r][c] = playerLetter;
      const after = totalSOS(board);
      scores.player += Math.max(0, after - before);
      turn = 'ai'; render();
      if(board.flat().every(x=>x)) return endMatch();
      setTimeout(()=>aiMove(), 350);
    });

    async function aiMove(){
      const move = aiChooseMove();
      if(!move) return endMatch();
      await new Promise(res=>setTimeout(res, 300 + Math.random()*400));
      const before = totalSOS(board);
      board[move.r][move.c] = move.letter;
      const after = totalSOS(board);
      scores.ai += Math.max(0, after - before);
      turn = 'player';
      render();
      if(board.flat().every(x=>x)) return endMatch();
    }

    function endMatch(){
      let result;
      if(scores.player > scores.ai) result='player';
      else if(scores.ai > scores.player) result='ai';
      else result='draw';
      log('SOS match result: ' + result + ` (You:${scores.player} AI:${scores.ai})`);
      if(result==='player'){
        consecutiveWins++;
        winsRemaining = Math.max(0, WINS_REQUIRED - consecutiveWins);
        updateWinsUI();
        if(consecutiveWins >= WINS_REQUIRED){
          $('#unlock-screen').classList.add('hide');
          $('#statusBox').textContent = 'UNLOCKED';
          log('Site unlocked after ' + consecutiveWins + ' wins');
          setTimeout(()=>alert('Congrats! You unlocked the site ❤️'), 50);
        } else {
          setTimeout(()=>alert('You won this match! Consecutive wins: ' + consecutiveWins), 50);
        }
      } else {
        consecutiveWins = 0;
        winsRemaining = WINS_REQUIRED;
        updateWinsUI();
        setTimeout(()=>alert(result === 'draw' ? 'It\'s a draw.' : 'AI won this match. Try again.'), 50);
      }
      sosUI.style.display = 'none';
      sosUI.classList.remove('show');
      $('#unlock-screen').classList.remove('hide');
    }

    restart.onclick = ()=>{ board = Array.from({length:SIZE},()=>Array(SIZE).fill('')); scores = {player:0,ai:0}; turn='player'; render(); log('SOS match restarted'); };
    close.onclick = ()=>{ sosUI.style.display='none'; sosUI.classList.remove('show'); $('#unlock-screen').classList.remove('hide'); };

    render();
    log('SOS UI created');
  }catch(e){ log('createSOS error: ' + (e.message || e)); console.error(e); }
} // end createSOS

/* Start/reset handlers */
$('#startSOS').addEventListener('click', ()=>{
  if(DEV_BYPASS){ $('#unlock-screen').classList.add('hide'); $('#statusBox').textContent='BYPASS ACTIVE — UNLOCKED'; log('StartSOS clicked — bypass active'); return; }
  $('#unlock-screen').classList.add('hide');
  $('#sosUI').style.display = 'flex';
  createSOS();
  log('StartSOS clicked');
});
$('#resetSOS').addEventListener('click', ()=>{ consecutiveWins=0; winsRemaining=WINS_REQUIRED; updateWinsUI(); log('SOS progress reset'); alert('SOS progress reset'); });

/* =========================
   Jigsaw (drag + snap)
   ========================= */
(function(){
  const fileInput = $('#jigsawFile'), startBtn = $('#startJigsaw');
  const board = $('#jigsawBoard'), msg = $('#jigsawMsg');
  let pieces = [], img = new Image(), cols=4, rows=4;

  fileInput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    img = new Image();
    img.src = URL.createObjectURL(f);
  });

  startBtn.addEventListener('click', ()=>{
    const f = fileInput.files[0];
    if(!f){ msg.innerText = 'Please upload a 9:16 image first.'; return; }
    const val = +$('#piecesCount').value;
    if(val<=9){ cols=3; rows=Math.ceil(val/3); }
    else if(val<=12){ cols=4; rows=3; } else { cols=4; rows=4; }
    img = new Image();
    img.onload = ()=> createPieces();
    img.src = URL.createObjectURL(f);
  });

  function createPieces(){
    board.innerHTML=''; pieces=[]; board.style.display='block'; msg.innerText='';
    const W = board.clientWidth, H = board.clientHeight;
    const pW = Math.floor(W/cols), pH = Math.floor(H/rows);
    const scale = Math.max(W/img.width, H/img.height);
    const drawW = img.width * scale, drawH = img.height * scale;
    const offsetX = (W - drawW)/2, offsetY = (H - drawH)/2;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const piece = document.createElement('div'); piece.className='j-piece';
        piece.style.width = pW + 'px'; piece.style.height = pH + 'px';
        const posX = c*pW, posY = r*pH;
        piece.style.backgroundImage = `url(${img.src})`;
        piece.style.backgroundSize = `${drawW}px ${drawH}px`;
        piece.style.backgroundPosition = `${offsetX - posX}px ${offsetY - posY}px`;
        piece.style.left = (Math.random()*(W-pW)) + 'px';
        piece.style.top = (Math.random()*(H-pH)) + 'px';
        piece.dataset.correctLeft = posX; piece.dataset.correctTop = posY; piece.dataset.snapRange = Math.max(12, Math.min(pW,pH)/3);
        board.appendChild(piece);
        makeDraggable(piece);
        pieces.push(piece);
      }
    }
    msg.innerText = 'Drag pieces to assemble the image. Pieces snap when close.';
    log('Jigsaw: pieces created: ' + pieces.length);
  }

  function makeDraggable(el){
    let dragging=false, sx=0, sy=0, ox=0, oy=0;
    function down(e){
      dragging=true;
      sx = e.clientX; sy = e.clientY;
      ox = parseFloat(el.style.left)||0; oy = parseFloat(el.style.top)||0;
      try{ el.setPointerCapture && el.setPointerCapture(e.pointerId); }catch(e){}
      el.style.transition='none';
    }
    function move(e){
      if(!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      el.style.left = (ox + dx) + 'px'; el.style.top = (oy + dy) + 'px';
    }
    function up(e){
      if(!dragging) return; dragging=false;
      try{ el.releasePointerCapture && el.releasePointerCapture(e.pointerId); }catch(e){}
      el.style.transition='transform .12s, left .12s, top .12s';
      const left = parseFloat(el.style.left)||0, top = parseFloat(el.style.top)||0;
      const correctLeft = +el.dataset.correctLeft, correctTop = +el.dataset.correctTop;
      const dist = Math.hypot(left-correctLeft, top-correctTop);
      const snapRange = +el.dataset.snapRange;
      if(dist <= snapRange){
        el.style.left = correctLeft + 'px';
        el.style.top = correctTop + 'px';
        el.style.transform = 'scale(1.02)';
        setTimeout(()=>el.style.transform='scale(1)',120);
      }
      checkComplete();
    }
    el.addEventListener('pointerdown', down);
    window.addEventListener('pointermove', move);
    window.addEventListener('pointerup', up);
    // mouse fallback
    el.addEventListener('mousedown', down);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', up);
  }

  function checkComplete(){
    if(pieces.length===0) return;
    const ok = pieces.every(p => {
      const left = Math.round(parseFloat(p.style.left)||0), top = Math.round(parseFloat(p.style.top)||0);
      return left === +p.dataset.correctLeft && top === +p.dataset.correctTop;
    });
    if(ok){
      $('#jigsawMsg').innerText = 'You solved it! ❤️';
      pieces.forEach(p => p.style.boxShadow = '0 12px 28px rgba(255,107,154,0.28)');
      log('Jigsaw complete');
    }
  }
})();

/* ======================
   Heart Maze (swipe + tilt)
   ====================== */
(function(){
  const canvas = $('#mazeCanvas');
  const wrap = $('#mazeWrap');
  const player = $('#playerDot');
  const msg = $('#mazeMsg');
  let ctx, W, H, path = [], playerPos = {x:0,y:0};

  function resize(){
    canvas.width = wrap.clientWidth; canvas.height = wrap.clientHeight; W = canvas.width; H = canvas.height;
    drawPath(); resetPlayer();
  }
  function makePath(cx,cy,scale=1){
    const pts=[]; const steps=140;
    for(let i=0;i<steps;i++){
      const t = i/steps*Math.PI*2;
      const x = cx + Math.sin(t)*scale*(Math.cos(t)>=0?0.9:1.1)*(60 + 40*Math.cos(t*3));
      const y = cy - (Math.cos(t)*scale*1.1*80 + Math.sin(t*2)*10);
      pts.push({x,y});
    }
    return pts;
  }
  function drawPath(){
    if(!canvas.getContext) return;
    ctx = canvas.getContext('2d'); ctx.clearRect(0,0,W,H);
    const cx=W/2, cy=H/2;
    path = makePath(cx,cy,Math.min(W,H)/440);
    ctx.lineWidth = Math.max(10, Math.min(W,H)/14);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.beginPath(); path.forEach((p,i)=> i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)); ctx.stroke();
    ctx.lineWidth=4; ctx.strokeStyle='rgba(255,107,154,0.16)'; ctx.beginPath(); path.forEach((p,i)=> i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)); ctx.stroke();
  }
  function resetPlayer(){ if(path.length){ playerPos = {...path[0]}; updatePlayer(); msg.innerText=''; } }
  function updatePlayer(){ const rect = wrap.getBoundingClientRect(); const left = playerPos.x - rect.left - 14; const top = playerPos.y - rect.top - 14; player.style.left = Math.max(4, Math.min(rect.width-32, left)) + 'px'; player.style.top = Math.max(4, Math.min(rect.height-32, top)) + 'px'; }

  let pointerActive=false;
  canvas.addEventListener('pointerdown', e=>{ pointerActive=true; moveToPoint(e); canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId); });
  canvas.addEventListener('pointermove', e=>{ if(pointerActive) moveToPoint(e); });
  window.addEventListener('pointerup', e=>{ pointerActive=false; });

  function moveToPoint(e){
    const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top;
    let bestIdx=0, bestDist=Infinity;
    for(let i=0;i<path.length;i++){ const p=path[i]; const d = Math.hypot(p.x - x, p.y - y); if(d < bestDist){ bestDist = d; bestIdx = i; } }
    playerPos = {...path[bestIdx]}; updatePlayer();
    if(bestIdx >= path.length - 6){
      msg.innerText = 'You found the way to my heart ❤️';
      log('Maze complete');
    }
  }

  // device tilt support (optional)
  if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', e=>{
      // small tilt mapping: gamma -> left/right, beta -> up/down
      const g = e.gamma || 0, b = e.beta || 0;
      if(path.length){
        // map gamma/beta to a nearest path index to move along
        const centerIdx = Math.floor((g+30)/60 * (path.length-1));
        const idx = Math.max(0, Math.min(path.length-1, centerIdx));
        playerPos = {...path[idx]}; updatePlayer();
      }
    }, true);
  }

  $('#resetMaze').addEventListener('click', ()=>{ resetPlayer(); msg.innerText=''; });

  window.addEventListener('resize', ()=> setTimeout(resize,120));
  setTimeout(resize,250);
})();

/* ======================
   Connect Hearts (dot-to-dot)
   ====================== */
(function(){
  const canvas = $('#connectCanvas'); const ctx = canvas.getContext('2d'); const msg = $('#connectMsg');
  let W,H,dots=[],lines=[],currentIndex=0;
  function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; W=canvas.width; H=canvas.height; initDots(); draw(); }
  function initDots(){
    dots = []; const center = {x:W/2,y:H/2}; const r = Math.min(W,H)/3;
    for(let i=0;i<14;i++){ const t = Math.PI*(i/13); const x = center.x + r*0.9*Math.sin(t)*Math.sin(t)*Math.cos(t); const y = center.y - r*(0.8*Math.cos(t)-0.2*Math.cos(2*t)); dots.push({x,y,idx:i+1}); }
    currentIndex = 1; lines = []; msg.innerText = 'Connect dot 1 → 2 → 3 ...';
  }
  function draw(){ ctx.clearRect(0,0,W,H); ctx.lineWidth=4; ctx.strokeStyle='rgba(255,107,154,0.95)'; ctx.beginPath(); for(const ln of lines){ ctx.moveTo(ln[0].x,ln[0].y); ctx.lineTo(ln[1].x,ln[1].y); } ctx.stroke(); for(const d of dots){ ctx.beginPath(); ctx.fillStyle = (d.idx <= currentIndex ? '#ff9fbf' : '#fff'); ctx.arc(d.x,d.y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.font='10px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(String(d.idx), d.x, d.y); } }
  function nearestDot(x,y){ let best=null,dist=1e4; for(const d of dots){ const dd=Math.hypot(d.x-x,d.y-y); if(dd<dist){ dist=dd; best=d; } } return dist<28 ? best : null; }

  let startDot=null;
  canvas.addEventListener('pointerdown', e=>{
    const rect = canvas.getBoundingClientRect();
    const nd = nearestDot(e.clientX-rect.left, e.clientY-rect.top);
    if(nd && nd.idx === currentIndex) startDot = nd;
  });
  canvas.addEventListener('pointerup', e=>{
    const rect = canvas.getBoundingClientRect();
    const nd = nearestDot(e.clientX-rect.left, e.clientY-rect.top);
    if(startDot && nd && nd.idx === currentIndex + 1){
      lines.push([startDot, nd]); currentIndex++;
      if(currentIndex >= dots.length) msg.innerText = 'Lovely! The heart appears ❤️';
      else msg.innerText = `Good — connect ${currentIndex} → ${currentIndex+1}`;
    }
    startDot = null; draw();
  });

  $('#resetConnect').addEventListener('click', ()=>{ initDots(); draw(); });
  window.addEventListener('resize', ()=> setTimeout(resize,120)); setTimeout(resize,200);
})();

/* ======================
   Timeline image input (simple preview insertion)
   ====================== */
(function(){
  const input = $('#tlImageInput');
  input && input.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    const card = document.createElement('img'); card.src = url; card.style.width='100%'; card.style.borderRadius='8px'; card.style.marginTop='8px';
    document.getElementById('timelineList').appendChild(card);
  });
})();

/* ======================
   Polaroid Gallery
   ====================== */
(function(){
  const input = $('#galleryFiles'), grid = $('#polaroidGrid'), clear = $('#clearGallery');
  input.addEventListener('change', e=>{
    const files = Array.from(e.target.files || []);
    for(const f of files){ const url = URL.createObjectURL(f); addPolaroid(url); }
  });
  function addPolaroid(src){
    const p = document.createElement('div'); p.className = 'polaroid';
    const img = document.createElement('img'); img.src = src; p.appendChild(img);
    // slight random tilt
    p.style.transform = `rotate(${(Math.random()*12 - 6).toFixed(2)}deg)`;
    p.addEventListener('click', ()=>{
      if(p.classList.contains('big')){ p.classList.remove('big'); p.style.transform = `rotate(${(Math.random()*12 - 6).toFixed(2)}deg)`; }
      else { p.classList.add('big'); p.style.transform = 'none'; }
    });
    grid.appendChild(p);
  }
  clear.addEventListener('click', ()=>{ grid.innerHTML = ''; input.value = ''; });
})();

/* ======================
   Notepad download (no trimming)
   ====================== */
(function(){
  const area = $('#noteArea'), btn = $('#downloadNote'), nameIn = $('#nameForFile');
  btn.addEventListener('click', ()=>{
    let filename = (nameIn.value || 'note.txt').trim();
    if(!filename.toLowerCase().endsWith('.txt')) filename += '.txt';
    const text = area.value; // exact text, no trimming
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    log('Notepad saved: ' + filename + ' (' + text.length + ' chars)');
  });
})();

/* ======================
   Init: autoplay, default page, status
   ====================== */
(function init(){
  showPage('welcome');
  log('App initialized; DEV_BYPASS=' + (DEV_BYPASS ? 'yes' : 'no') + ' CHANCE_TO_MISTAKE=' + CHANCE_TO_MISTAKE);
  // autoplay attempt
  const v = $('#welcomeVideo'); if(v) v.play().catch(()=> log('Video autoplay blocked (user gesture required)'));
})();
</script>
</body>
</html>
