<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Saraaa ‚ù§Ô∏è ‚Äî Eternal Love (Final)</title>
<style>
  /* ------------------------
     Romantic gradient + mobile-first
     ------------------------ */
  :root{
    --bg: linear-gradient(180deg,#120021 0%, #2b0036 55%, #3b0b2f 100%);
    --card: rgba(255,255,255,0.06);
    --glass-glow: rgba(255,107,107,0.12);
    --accentA: #ff6b6b;
    --accentB: #ff9aa2;
    --accent-grad: linear-gradient(90deg,var(--accentA),var(--accentB));
    --muted: rgba(255,255,255,0.85);
    --radius: 16px;
    --transition: 220ms cubic-bezier(.2,.9,.2,1);
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
  .wrap{max-width:680px;margin:0 auto;min-height:100vh;padding:86px 16px 120px}
  header{position:fixed;left:0;right:0;top:0;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.02));backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.03);z-index:120}
  .head-inner{max-width:680px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:18px;font-weight:900;background:var(--accent-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .small{font-size:12px;color:var(--muted)}
  .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.04);border:none;color:#fff;font-weight:700;cursor:pointer;transition:var(--transition)}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--glass-glow);box-shadow:0 10px 30px rgba(0,0,0,0.28);margin-bottom:14px}
  .title{font-weight:900;font-size:20px;margin:0 0 8px;background:var(--accent-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .subtitle{color:var(--muted);font-size:14px;margin:0 0 10px}
  .muted{color:var(--muted)}
  .nav{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,0.32),rgba(0,0,0,0.02));backdrop-filter:blur(10px);display:flex;gap:10px;justify-content:center;z-index:130}
  .nav button{flex:1;padding:10px 12px;border-radius:12px;border:none;background:rgba(255,255,255,0.03);color:#fff;font-weight:800;cursor:pointer}
  .nav button.active{background:var(--accent-grad);color:#fff;transform:scale(1.02)}

  /* SOS board */
  .sos-board{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .sos-cell{aspect-ratio:1;border-radius:12px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;border:none;color:#fff;cursor:pointer;transition:var(--transition)}
  .sos-cell:disabled{opacity:0.45;cursor:not-allowed}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-top:12px}
  .progress>div{height:100%;width:0;background:var(--accent-grad);transition:width .36s ease}

  /* Settings area */
  .settings { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .select { background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:10px; color:#fff; font-weight:700; border:none; cursor:pointer; }

  /* video area */
  .video-slot{width:100%;aspect-ratio:9/16;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,#ff6b6b,#ff9aa2);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;text-align:center}
  .video-emoji{font-size:58px;margin-bottom:8px}
  .video-title{font-weight:900;font-size:18px;margin-bottom:6px}
  .video-msg{font-size:14px;color:var(--muted);max-height:32%;overflow:auto;padding:6px 4px}

  /* simple game cards layout */
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

  /* timeline */
  .timeline{display:flex;flex-direction:column;gap:10px}
  .milestone{display:flex;gap:10px;align-items:flex-start}
  .milestone .dot{width:40px;height:40px;border-radius:50%;background:linear-gradient(90deg,#ff7b93,#ffb6c6);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff}

  /* polaroid */
  .polaroid-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
  .polaroid{background:#fff;border-radius:12px;padding:10px;color:#222;cursor:pointer}
  .polaroid img{width:100%;aspect-ratio:9/16;object-fit:cover;border-radius:8px}

  /* notes */
  .txtarea{width:100%;min-height:170px;border-radius:12px;padding:12px;border:none;font-family:'Dancing Script',cursive;font-size:18px;background:#fff;color:#222;resize:vertical}

  /* modal */
  .modal { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:240; padding:16px; background: rgba(0,0,0,0.6); }
  .modal .box { background:#fff; color:#222; padding:14px; border-radius:12px; width:100%; max-width:680px; max-height:90vh; overflow:auto; }

  @media(min-width:760px){ .wrap{padding-left:30px;padding-right:30px} }
</style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div style="display:flex;gap:12px;align-items:center">
        <button id="devMenu" class="pill">‚ò∞</button>
        <div>
          <h1>Saraaa ‚ù§Ô∏è</h1>
          <div class="small">My Eternal Flame</div>
        </div>
      </div>
      <div style="text-align:right">
        <div id="winDisplay" class="small">Wins: 0 / 3</div>
        <div id="streakDisplay" class="small">Streak: 0/3</div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- SOS unlock card -->
    <section id="unlockCard" class="card">
      <div class="title">üîê Unlock Our Story</div>
      <div class="subtitle">Win 3 SOS games in a row to reveal the whole site. Minimax AI enabled.</div>

      <div id="sosMessage" class="muted" style="text-align:center;margin-bottom:10px;">Choose S or O then tap an empty cell.</div>

      <div id="sosBoard" class="sos-board" aria-label="SOS board"></div>

      <div class="controls">
        <button id="selectS" class="pill">S</button>
        <button id="selectO" class="pill">O</button>
        <button id="resetGame" class="pill">Reset</button>
        <button id="openGuide" class="pill">Guide</button>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;align-items:center;justify-content:center;flex-wrap:wrap">
        <div class="settings">
          <label class="small">AI Level</label>
          <select id="aiLevel" class="select">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard (Minimax)</option>
          </select>
        </div>
        <div class="settings">
          <label class="small">Mistake</label>
          <input id="mistake" type="range" min="0" max="80" value="35" />
          <div class="small" id="mistakeVal">35%</div>
        </div>
        <div class="settings">
          <label class="small">Skip SOS</label>
          <input id="skipSOS" type="checkbox" />
        </div>
      </div>

      <div class="progress"><div id="progBar"></div></div>

      <div style="display:flex;justify-content:space-between;margin-top:10px;align-items:center">
        <div id="scoreDisplay" style="font-weight:900">0 - 0</div>
        <div class="small" id="hint">AI: Full Minimax available</div>
      </div>
    </section>

    <!-- Hidden pages container -->
    <section id="pages" style="display:none">
      <!-- Page 1: Videos & Messages -->
      <div id="pageVideos" class="card">
        <div class="title">üéûÔ∏è Videos & Messages</div>
        <div class="subtitle">Swipe through romantic moments (9:16) and read the long messages.</div>
        <div id="videoSlot" class="video-slot">
          <div id="vEmoji" class="video-emoji">üíï</div>
          <div id="vTitle" class="video-title">Our Eternal Flame</div>
          <div id="vMsg" class="video-msg"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:10px;align-items:center">
          <button id="prevVideo" class="pill">‚Üê Prev</button>
          <div id="videoCounter" class="pill" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">1 / 5</div>
          <button id="nextVideo" class="pill">Next ‚Üí</button>
        </div>
      </div>

      <!-- Page 2: Games -->
      <div id="pageGames" class="card">
        <div class="title">üéÆ Playful Moments</div>
        <div class="subtitle">Touch-friendly mini-games ‚Äî Jigsaw, Maze, Connect.</div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button id="startJig" class="pill">üß© Jigsaw</button>
          <button id="startMaze" class="pill">‚ù§Ô∏è Maze</button>
          <button id="startDots" class="pill">üíå Connect</button>
        </div>
        <div id="gamesArea" style="margin-top:12px"></div>
      </div>

      <!-- Page 3: Timeline -->
      <div id="pageTimeline" class="card">
        <div class="title">üíï Our Journey</div>
        <div class="timeline" id="timelineList"></div>
      </div>

      <!-- Page 4: Polaroids -->
      <div id="pageGallery" class="card">
        <div class="title">üì∏ Cherished Snaps</div>
        <div class="polaroid-grid" id="polaroidGrid"></div>
      </div>

      <!-- Page 5: Notes -->
      <div id="pageNotes" class="card">
        <div class="title">üíå Whispered Words</div>
        <textarea id="notes" class="txtarea" placeholder="Dearest Saraaa, in the quiet of my heart..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="downloadNotes" class="pill">üíæ Save TXT</button>
          <button id="clearNotes" class="pill">Clear</button>
        </div>
      </div>
    </section>
  </div>

  <nav class="nav" id="bottomNav" style="display:none">
    <button data-i="0" class="active">Videos</button>
    <button data-i="1">Games</button>
    <button data-i="2">Timeline</button>
    <button data-i="3">Gallery</button>
    <button data-i="4">Notes</button>
  </nav>

  <!-- Modal (Guide / Zoom) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <div id="modalContent"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="closeModal" class="pill">Close</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Configurable constants
   =========================== */
const CONFIG = {
  AI_LEVEL: 'hard', // default 'easy' | 'medium' | 'hard'
  MISTAKE_CHANCE: 0.35, // 0.0 - 1.0
  SKIP_SOS: false
};

/* We'll wire UI controls to these live values later. */

/* ===========================
   Data (videos, timeline, polaroids)
   Replace placeholders with real files if you have them
   =========================== */
const VIDEOS = [
  {emoji:'üíï', title:'Our Eternal Flame', msg:`From the stars above to the depths of my soul, you are my everything. Every beat of my heart whispers your name in the quiet night.`},
  {emoji:'üåô', title:'Whispers in the Night', msg:`In the silence of midnight, your voice is my lullaby. We share dreams that dance like fireflies under the velvet sky.`},
  {emoji:'‚ú®', title:'Adventures Unwritten', msg:`Hand in hand, we'll chase horizons yet to see. Our path is paved with laughter, love, and endless possibility.`},
  {emoji:'üíû', title:'Hearts Intertwined', msg:`Our love, a tapestry woven with threads of gold. Each moment with you is a brushstroke on the canvas of forever.`},
  {emoji:'üå∏', title:'Forever Blooms', msg:`Like roses in spring, our story never fades. You are the bloom that colors my world in hues of eternal spring.`}
];

const MILESTONES = [
  {emoji:'üëÄ', title:'First Glance', desc:'Eyes locked, worlds collided in a spark of destiny.'},
  {emoji:'üòò', title:'First Kiss', desc:'Sparks flew, time stood still in that magical embrace.'},
  {emoji:'üåü', title:'Promises Made', desc:'Under the moon, forever sealed with whispered vows.'},
  {emoji:'üíç', title:'Our Vows', desc:'Eternity in a single yes, hearts forever bound.'},
  {emoji:'‚ôæÔ∏è', title:'Infinite Us', desc:'Love without end, a circle of joy unending.'}
];

const POLAROIDS = Array.from({length:8},(_,i)=>({
  title:['Sunset Stroll','Cozy Nights','Beach Whispers','Starlit Dances','Coffee Dates','Rainy Kisses','Festival Lights','Quiet Mornings'][i],
  // placeholder simple white svg; replace with data URLs or real paths
  img:'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjM1NSI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIzNTUiIGZpbGw9IiNmZmYiLz48L3N2Zz4=',
  desc:'A snapshot of our joy.'
}));

/* ===========================
   SOS Game State
   =========================== */
let sosBoard = Array(9).fill(null); // null | 'S' | 'O'
let humanTurn = true;
let selectedLetter = 'S';
let scores = {human:0, ai:0};
let streak = 0;
let unlocked = false;

/* DOM references */
const sosBoardEl = document.getElementById('sosBoard');
const selectSBtn = document.getElementById('selectS');
const selectOBtn = document.getElementById('selectO');
const resetBtn = document.getElementById('resetGame');
const guideBtn = document.getElementById('openGuide');
const aiLevelEl = document.getElementById('aiLevel');
const mistakeEl = document.getElementById('mistake');
const mistakeValEl = document.getElementById('mistakeVal');
const skipCheckbox = document.getElementById('skipSOS');
const progBar = document.getElementById('progBar');
const scoreDisplay = document.getElementById('scoreDisplay');
const sosMessage = document.getElementById('sosMessage');
const winDisplay = document.getElementById('winDisplay');
const streakDisplay = document.getElementById('streakDisplay');
const bottomNav = document.getElementById('bottomNav');
const pagesSection = document.getElementById('pages');
const unlockCard = document.getElementById('unlockCard');

/* Video DOM */
const vEmoji = document.getElementById('vEmoji');
const vTitle = document.getElementById('vTitle');
const vMsg = document.getElementById('vMsg');
const prevVideo = document.getElementById('prevVideo');
const nextVideo = document.getElementById('nextVideo');
const videoCounter = document.getElementById('videoCounter');

let videoIndex = 0;

/* Modal */
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const closeModalBtn = document.getElementById('closeModal');

/* Games area */
const gamesArea = document.getElementById('gamesArea');

/* Timeline & Polaroid DOM */
const timelineList = document.getElementById('timelineList');
const polaroidGrid = document.getElementById('polaroidGrid');

/* Notes */
const notesArea = document.getElementById('notes');
const downloadNotesBtn = document.getElementById('downloadNotes');
const clearNotesBtn = document.getElementById('clearNotes');

/* Bottom nav buttons */
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    // scroll to approximate card (simple UX)
    const idx = Number(btn.dataset.i);
    const cards = Array.from(document.querySelectorAll('.card'));
    if(cards[idx]) cards[idx].scrollIntoView({behavior:'smooth',block:'center'});
  });
});

/* ===========================
   Utility functions
   =========================== */
function updateScoreDisplay(){
  scoreDisplay.textContent = `${scores.human} - ${scores.ai}`;
}
function updateProgress(){
  progBar.style.width = `${Math.min(100,(streak/3)*100)}%`;
  winDisplay.textContent = `Wins: ${streak} / 3`;
  streakDisplay.textContent = `Streak: ${streak}/3`;
}

/* ===========================
   SOS: rendering & interactions
   =========================== */
function renderSOS(){
  sosBoardEl.innerHTML = '';
  for(let i=0;i<9;i++){
    const b = document.createElement('button');
    b.className = 'sos-cell';
    b.textContent = sosBoard[i] || '';
    b.disabled = !!sosBoard[i] || !humanTurn || unlocked;
    b.onclick = ()=>handleHumanMove(i);
    sosBoardEl.appendChild(b);
  }
  updateScoreDisplay();
}

selectSBtn.addEventListener('click', ()=>{
  selectedLetter='S';
  selectSBtn.classList.add('pill','active');
  selectOBtn.classList.remove('active');
});
selectOBtn.addEventListener('click', ()=>{
  selectedLetter='O';
  selectOBtn.classList.add('pill','active');
  selectSBtn.classList.remove('active');
});

resetBtn.addEventListener('click', ()=>{resetRound();streak=0;updateProgress();});
guideBtn.addEventListener('click', ()=>openGuideModal());

mistakeEl.addEventListener('input', ()=>{
  mistakeValEl.textContent = `${mistakeEl.value}%`;
  CONFIG.MISTAKE_CHANCE = Number(mistakeEl.value)/100;
});
aiLevelEl.addEventListener('change', ()=>{CONFIG.AI_LEVEL = aiLevelEl.value;});
skipCheckbox.addEventListener('change', ()=>{
  CONFIG.SKIP_SOS = skipCheckbox.checked;
  if(CONFIG.SKIP_SOS) unlockAll();
});

/* initialize UI controls to defaults */
aiLevelEl.value = CONFIG.AI_LEVEL;
mistakeEl.value = CONFIG.MISTAKE_CHANCE * 100;
mistakeValEl.textContent = `${Math.round(CONFIG.MISTAKE_CHANCE*100)}%`;
skipCheckbox.checked = CONFIG.SKIP_SOS;

/* Human move */
function handleHumanMove(i){
  if(sosBoard[i]) return;
  if(!humanTurn) return;
  sosBoard[i] = selectedLetter;
  const got = countNewSOS(i, sosBoard);
  scores.human += got;
  renderSOS();
  if(got>0){
    sosMessage.textContent = `Nice! You formed ${got} new SOS. Extra turn.`;
    if(isBoardFull()) finishRound();
    return; // human gets extra turn
  }
  if(isBoardFull()){ finishRound(); return; }
  humanTurn = false;
  sosMessage.textContent = `AI is thinking...`;
  setTimeout(()=>aiPlay(), 450);
}

/* check if board full */
function isBoardFull(){
  return sosBoard.every(c=>c!==null);
}

/* count SOS that include index on a provided board */
function countNewSOS(idx, board){
  if(board[idx]===null) return 0;
  const lines = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  let c = 0;
  for(const L of lines){
    if(L.includes(idx)){
      const [a,b,d] = L;
      if(board[a]==='S' && board[b]==='O' && board[d]==='S') c++;
    }
  }
  return c;
}

/* returns list of empty indices */
function emptyIndices(board){
  return board.map((v,i)=>v===null?i:null).filter(x=>x!==null);
}

/* ===========================
   MINIMAX AI Implementation
   - The state space is small; we will explore deeply.
   - We'll implement alpha-beta and memoization.
   - Evaluate final score difference (ai - human).
   =========================== */

/* helper to create memo key */
function boardKey(board, turn){
  return board.map(x=>x||'.').join('') + '|' + turn;
}

/* minimax: returns {score, move: idx, letter: 'S'|'O'} for maximizing player (AI)
   We model the recursive game to completion: for each empty pos, try 'S' and 'O'
   Score at each place = immediate points for the player (move) + subsequent recursion (with players swapped).
   We compute (aiScore - humanScore) at leaves.
*/
function minimaxSolve(board, turn, alpha=-Infinity, beta=Infinity, memo=new Map()){
  const key = boardKey(board, turn);
  if(memo.has(key)) return memo.get(key);

  const empties = emptyIndices(board);
  if(empties.length===0){
    // game over: no more moves
    return { score: 0, move: null, letter: null };
  }
  const maximizing = (turn==='ai');
  let best = maximizing ? {score:-Infinity, move:null, letter:null} : {score:Infinity, move:null, letter:null};

  // For each move position and letter choice
  for(const pos of empties){
    for(const letter of ['S','O']){
      // simulate
      const nb = board.slice();
      nb[pos] = letter;
      const pts = countNewSOS(pos, nb); // points for player who played
      // recurse: next turn is the other player
      const res = minimaxSolve(nb, (turn==='ai'?'human':'ai'), alpha, beta, memo);
      // combine: pts belongs to current player; res.score is the (ai - human) from the rest of game
      let combined;
      if(turn==='ai') {
        // ai gets pts => combined score = pts + res.score
        combined = pts + res.score;
      } else {
        // human gets pts => combined score = res.score - pts (because score is ai - human)
        combined = res.score - pts;
      }

      if(maximizing){
        if(combined > best.score){
          best = {score: combined, move: pos, letter: letter};
        }
        alpha = Math.max(alpha, best.score);
      } else {
        if(combined < best.score){
          best = {score: combined, move: pos, letter: letter};
        }
        beta = Math.min(beta, best.score);
      }
      if(beta <= alpha) break; // prune
    }
    if(beta <= alpha) break;
  }

  memo.set(key, best);
  return best;
}

/* AI decision wrapper: uses CONFIG.AI_LEVEL and CONFIG.MISTAKE_CHANCE */
function pickAIMove(board){
  const empties = emptyIndices(board);
  // easy: random
  if(CONFIG.AI_LEVEL === 'easy'){
    const pos = empties[Math.floor(Math.random()*empties.length)];
    const letter = Math.random()<0.6 ? 'S' : 'O';
    return {pos, letter, reason:'easy-random'};
  }
  // hard or medium: use minimax but medium may allow mistakes
  // compute minimax best
  const memo = new Map();
  const best = minimaxSolve(board, 'ai', -Infinity, Infinity, memo);
  // best.move and best.letter
  if(best.move===null){
    // fallback random
    const pos = empties[Math.floor(Math.random()*empties.length)];
    const letter = Math.random()<0.6 ? 'S' : 'O';
    return {pos, letter, reason:'fallback'};
  }

  // Mistake chance handling: medium or specified mistake percentage
  const mistake = CONFIG.MISTAKE_CHANCE;
  if(CONFIG.AI_LEVEL === 'hard'){
    // if hard -> no mistakes
    return {pos: best.move, letter: best.letter, reason:'minimax-optimal'};
  } else {
    if(Math.random() < mistake){
      // make a suboptimal move: random empty with random letter
      const pos = empties[Math.floor(Math.random()*empties.length)];
      const letter = Math.random()<0.6 ? 'S' : 'O';
      return {pos, letter, reason:'mistake'};
    }
    return {pos: best.move, letter: best.letter, reason:'minimax'};
  }
}

/* ===========================
   AI play function
   =========================== */
function aiPlay(){
  if(unlocked) return;
  const pick = pickAIMove(sosBoard.slice());
  // execute move
  const pos = pick.pos;
  const letter = pick.letter;
  sosBoard[pos] = letter;
  const newPts = countNewSOS(pos, sosBoard);
  scores.ai += newPts;
  renderSOS();
  // update message
  if(newPts>0){
    sosMessage.textContent = `AI formed ${newPts} SOS. AI goes again.`;
    if(isBoardFull()) finishRound();
    else setTimeout(aiPlay, 420); // AI extra turn if scored
    return;
  }
  if(isBoardFull()){ finishRound(); return; }
  // give back to human
  humanTurn = true;
  sosMessage.textContent = `Your turn!`;
}

/* ===========================
   Round & unlock logic
   =========================== */
function finishRound(){
  // compare scores
  if(scores.human > scores.ai){
    streak++;
    sosMessage.textContent = `You win this round! (${scores.human} - ${scores.ai}) Streak increased.`;
  } else if(scores.ai > scores.human){
    streak = 0;
    sosMessage.textContent = `AI wins this round. (${scores.ai} - ${scores.human}) Streak reset.`;
  } else {
    streak = 0;
    sosMessage.textContent = `Tie (${scores.human} - ${scores.ai}). Streak reset.`;
  }
  scores = {human:0, ai:0};
  updateScoreDisplay();
  updateProgress();

  if(streak >= 3){
    setTimeout(()=> {
      unlockAll();
    }, 700);
    return;
  }
  // reset board after a short pause
  setTimeout(()=>{ resetRound(); }, 900);
}
function resetRound(){
  sosBoard = Array(9).fill(null);
  humanTurn = true;
  selectedLetter = 'S';
  scores = {human:0, ai:0};
  renderSOS();
  updateScoreDisplay();
  sosMessage.textContent = 'Choose S or O then tap an empty cell.';
}
function unlockAll(){
  unlocked = true;
  sosMessage.textContent = 'üéâ Congratulations! All pages unlocked. Enjoy our story ‚ù§Ô∏è';
  // hide unlock card and show pages
  unlockCard.style.display = 'none';
  pagesSection.style.display = 'block';
  bottomNav.style.display = 'flex';
  // set progress full
  progBar.style.width = '100%';
}

/* ===========================
   Initialize SOS UI & optionally skip
   =========================== */
function initSOS(){
  // Map config UI to live config
  CONFIG.AI_LEVEL = aiLevelEl.value;
  CONFIG.MISTAKE_CHANCE = Number(mistakeEl.value)/100;
  CONFIG.SKIP_SOS = skipCheckbox.checked;

  if(CONFIG.SKIP_SOS){
    streak = 3;
    updateProgress();
    unlockAll();
    return;
  }
  // ensure clear
  resetRound();
  renderSOS();
  updateProgress();
}
initSOS();

/* ===========================
   Render helper functions
   =========================== */
function renderSOS(){
  renderSOSBoard();
  updateScoreDisplay();
}
function renderSOSBoard(){
  sosBoardEl.innerHTML = '';
  for(let i=0;i<9;i++){
    const b = document.createElement('button');
    b.className = 'sos-cell';
    b.textContent = sosBoard[i] || '';
    b.disabled = !!sosBoard[i] || !humanTurn || unlocked;
    (function(idx){
      b.addEventListener('click', ()=>{
        if(unlocked) return;
        if(!humanTurn) return;
        if(sosBoard[idx]) return;
        sosBoard[idx] = selectedLetter;
        const got = countNewSOS(idx, sosBoard);
        scores.human += got;
        renderSOSBoard();
        updateScoreDisplay();
        if(got > 0){
          sosMessage.textContent = `Great! You formed ${got} SOS. Extra turn.`;
          if(isBoardFull()) finishRound();
          return;
        }
        if(isBoardFull()){ finishRound(); return; }
        humanTurn = false;
        sosMessage.textContent = 'AI is thinking...';
        setTimeout(aiPlay, 420);
      });
    })(i);
    sosBoardEl.appendChild(b);
  }
}

/* ===========================
   Videos & messages UI
   =========================== */
function renderVideoIndex(){
  const v = VIDEOS[videoIndex];
  vEmoji.textContent = v.emoji;
  vTitle.textContent = v.title;
  vMsg.textContent = v.msg;
  videoCounter.textContent = `${videoIndex+1} / ${VIDEOS.length}`;
}
document.getElementById('prevVideo').addEventListener('click', ()=>{
  videoIndex = (videoIndex - 1 + VIDEOS.length) % VIDEOS.length;
  renderVideoIndex();
});
document.getElementById('nextVideo').addEventListener('click', ()=>{
  videoIndex = (videoIndex + 1) % VIDEOS.length;
  renderVideoIndex();
});
renderVideoIndex();

/* ===========================
   Timeline & Polaroids
   =========================== */
function renderTimeline(){
  timelineList.innerHTML = '';
  MILESTONES.forEach((m,i)=>{
    const el = document.createElement('div');
    el.className = 'milestone';
    el.innerHTML = `<div class="dot">${m.emoji}</div><div><div style="font-weight:800">${m.title}</div><div class="small">${m.desc}</div></div>`;
    timelineList.appendChild(el);
  });
}
renderTimeline();

function renderPolaroids(){
  polaroidGrid.innerHTML = '';
  POLAROIDS.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'polaroid';
    el.innerHTML = `<img src="${p.img}" alt="${p.title}"><div style="font-weight:800;margin-top:8px">${p.title}</div><div class="small">${p.desc}</div>`;
    el.addEventListener('click', ()=> openModal(`<img src="${p.img}" style="width:100%;aspect-ratio:9/16;border-radius:8px"><h3 style="margin:10px 0 6px">${p.title}</h3><p>${p.desc}</p>`));
    polaroidGrid.appendChild(el);
  });
}
renderPolaroids();

/* ===========================
   Notes download
   =========================== */
downloadNotesBtn.addEventListener('click', ()=>{
  const text = notesArea.value || '';
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `saraaa-love-${new Date().toISOString().slice(0,10)}.txt`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
clearNotesBtn.addEventListener('click', ()=>{ notesArea.value = ''; });

/* ===========================
   Games: Jigsaw (simple, touch friendly),
   Maze (swipe), Dots (connect)
   These are functional and mobile-optimized
   =========================== */

/* Jigsaw: simple fiddly 9 piece drag+snap */
function startJigsaw(){
  gamesArea.innerHTML = '';
  const area = document.createElement('div');
  area.style.width = '100%';
  area.style.aspectRatio = '9/16';
  area.style.background = 'linear-gradient(135deg,#ffc1cc,#ffdede)';
  area.style.borderRadius = '12px';
  area.style.position = 'relative';
  area.style.overflow = 'hidden';
  gamesArea.appendChild(area);

  const slots = [
    {x:20,y:18},{x:50,y:18},{x:80,y:18},
    {x:20,y:50},{x:50,y:50},{x:80,y:50},
    {x:20,y:82},{x:50,y:82},{x:80,y:82}
  ];
  // create slots
  slots.forEach(s=>{
    const el = document.createElement('div');
    el.style.position='absolute';
    el.style.left = s.x + '%';
    el.style.top = s.y + '%';
    el.style.width='64px';
    el.style.height='64px';
    el.style.transform='translate(-50%,-50%)';
    el.style.border='2px dashed rgba(255,255,255,0.5)';
    el.style.borderRadius='8px';
    area.appendChild(el);
  });

  // create movable pieces
  const pieces = [];
  for(let i=0;i<9;i++){
    const p = document.createElement('div');
    p.className = 'jig-piece';
    p.style.position = 'absolute';
    p.style.left = (10 + Math.random()*70) + '%';
    p.style.top = (10 + Math.random()*70) + '%';
    p.style.width = '58px';
    p.style.height = '58px';
    p.style.background = '#fff';
    p.style.color = '#333';
    p.style.borderRadius = '8px';
    p.style.display='flex';
    p.style.alignItems='center';
    p.style.justifyContent='center';
    p.style.fontWeight='900';
    p.style.boxShadow='0 8px 26px rgba(0,0,0,0.15)';
    p.draggable = true;
    p.textContent = (i+1);
    area.appendChild(p);
    pieces.push(p);
    p.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', i); setTimeout(()=>p.style.opacity='0.6',0);});
    p.addEventListener('dragend', ()=>{ p.style.opacity='1';});
  }
  area.addEventListener('dragover', (e)=>e.preventDefault());
  area.addEventListener('drop', (e)=>{
    e.preventDefault();
    const idx = Number(e.dataTransfer.getData('text/plain'));
    const rect = area.getBoundingClientRect();
    const mouseX = ((e.clientX - rect.left)/rect.width)*100;
    const mouseY = ((e.clientY - rect.top)/rect.height)*100;
    // find nearest slot
    let minD=Infinity, nearest=null;
    slots.forEach((s,j)=>{
      const dx = s.x - mouseX, dy = s.y - mouseY;
      const d = Math.hypot(dx,dy);
      if(d<minD){ minD=d; nearest={s,j}; }
    });
    const piece = pieces[idx];
    if(minD < 15){
      piece.style.left = nearest.s.x + '%'; piece.style.top = nearest.s.y + '%';
      piece.style.background = 'linear-gradient(90deg,#ff6b6b,#ff9aa2)';
      piece.style.color='#fff';
      piece.setAttribute('data-placed', nearest.j);
    } else {
      piece.style.left = Math.max(4, Math.min(96, mouseX)) + '%';
      piece.style.top = Math.max(4, Math.min(96, mouseY)) + '%';
    }
    // check complete
    if(pieces.every(p=>p.hasAttribute('data-placed'))){
      setTimeout(()=>alert('Puzzle Complete! üéâ'), 420);
    }
  });
}

/* Maze: simple swipe/tap movement */
function startMaze(){
  gamesArea.innerHTML='';
  const area = document.createElement('div');
  area.style.width='100%'; area.style.aspectRatio='9/16'; area.style.background='linear-gradient(135deg,#ffdede,#ffe6f0)'; area.style.borderRadius='12px'; area.style.position='relative'; area.style.overflow='hidden';
  gamesArea.appendChild(area);
  // heart
  const heart = document.createElement('div');
  heart.id='mazeHeart';
  heart.style.position='absolute';
  heart.style.left='12%'; heart.style.top='12%';
  heart.style.transform='translate(-50%,-50%)';
  heart.style.width='44px'; heart.style.height='44px'; heart.style.borderRadius='50%';
  heart.style.display='flex'; heart.style.alignItems='center'; heart.style.justifyContent='center';
  heart.style.background='linear-gradient(90deg,#ff6b6b,#ff9aa2)';
  heart.style.fontSize='20px'; heart.textContent='‚ù§Ô∏è';
  area.appendChild(heart);
  // goal
  const goal = document.createElement('div');
  goal.style.position='absolute'; goal.style.right='8%'; goal.style.bottom='8%'; goal.style.width='44px'; goal.style.height='44px'; goal.style.borderRadius='50%'; goal.style.background='#ffd166'; goal.style.display='flex'; goal.style.alignItems='center'; goal.style.justifyContent='center'; goal.textContent='‚≠ê';
  area.appendChild(goal);
  // walls (simple)
  const walls = [
    {l:36,t:0,w:8,h:46},{l:0,t:40,w:30,h:8},{l:65,t:52,w:35,h:8}
  ];
  walls.forEach(w=>{
    const el = document.createElement('div');
    el.style.position='absolute'; el.style.left = w.l+'%'; el.style.top = w.t+'%'; el.style.width = w.w+'%'; el.style.height = w.h+'%';
    el.style.background='rgba(0,0,0,0.12)'; el.style.borderRadius='6px';
    area.appendChild(el);
  });
  // movement via touch swipe
  let tx, ty;
  area.addEventListener('touchstart', (e)=>{ tx = e.touches[0].clientX; ty = e.touches[0].clientY; }, {passive:true});
  area.addEventListener('touchend', (e)=>{
    if(!tx) return;
    const dx = e.changedTouches[0].clientX - tx;
    const dy = e.changedTouches[0].clientY - ty;
    const absX = Math.abs(dx), absY = Math.abs(dy);
    if(Math.max(absX,absY) < 30) { tx=null; return; }
    if(absX>absY){
      if(dx>0) moveMaze('right', heart, area, goal);
      else moveMaze('left', heart, area, goal);
    } else {
      if(dy>0) moveMaze('down', heart, area, goal);
      else moveMaze('up', heart, area, goal);
    }
    tx=null;
  }, {passive:true});
  // arrow buttons fallback
  const controls = document.createElement('div');
  controls.style.display='flex'; controls.style.gap='8px'; controls.style.marginTop='10px'; controls.style.justifyContent='center';
  ['‚¨ÜÔ∏è','‚¨ÖÔ∏è','‚¨áÔ∏è','‚û°Ô∏è'].forEach((label,idx)=>{
    const btn = document.createElement('button'); btn.className='pill'; btn.textContent=label;
    btn.addEventListener('click', ()=> {
      if(label==='‚¨ÜÔ∏è') moveMaze('up',heart,area,goal);
      if(label==='‚¨áÔ∏è') moveMaze('down',heart,area,goal);
      if(label==='‚¨ÖÔ∏è') moveMaze('left',heart,area,goal);
      if(label==='‚û°Ô∏è') moveMaze('right',heart,area,goal);
    });
    controls.appendChild(btn);
  });
  gamesArea.appendChild(controls);
}
function moveMaze(dir, heart, area, goal){
  const step = 12; // percent
  const rect = area.getBoundingClientRect();
  const curX = parseFloat(heart.style.left);
  const curY = parseFloat(heart.style.top);
  let nx = curX, ny = curY;
  if(dir==='up') ny = Math.max(6, curY - step);
  if(dir==='down') ny = Math.min(94, curY + step);
  if(dir==='left') nx = Math.max(6, curX - step);
  if(dir==='right') nx = Math.min(94, curX + step);
  heart.style.left = nx+'%'; heart.style.top = ny+'%';
  // check goal proximity (goal is bottom-right)
  if(nx>78 && ny>78){
    heart.classList.add('pulse');
    setTimeout(()=>{ alert('Maze Master! You reached the goal! ‚≠ê‚ù§Ô∏è'); heart.classList.remove('pulse'); heart.style.left='12%'; heart.style.top='12%'; }, 600);
  }
}

/* Dots Connect */
function startDots(){
  gamesArea.innerHTML = '';
  const area = document.createElement('div');
  area.style.width='100%'; area.style.height='240px'; area.style.position='relative';
  gamesArea.appendChild(area);
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 100 100'); svg.style.position='absolute'; svg.style.inset='0'; svg.style.width='100%'; svg.style.height='100%';
  area.appendChild(svg);
  const grid = document.createElement('div');
  grid.style.position='absolute'; grid.style.inset='6px'; grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(3,1fr)'; grid.style.gap='12px';
  area.appendChild(grid);

  const positions = [
    [15,15],[50,15],[85,15],
    [15,50],[50,50],[85,50],
    [15,85],[50,85],[85,85]
  ];
  let connected = [];
  for(let i=0;i<9;i++){
    const d = document.createElement('div');
    d.className='pill'; d.style.width='52px'; d.style.height='52px'; d.style.borderRadius='50%'; d.style.display='flex'; d.style.alignItems='center'; d.style.justifyContent='center';
    d.textContent = i+1; d.style.fontWeight='900';
    d.addEventListener('click', ()=> {
      if(connected.includes(i)) return;
      connected.push(i);
      d.style.background = 'linear-gradient(90deg,#ff6b6b,#ff9aa2)'; d.style.color='#fff';
      if(connected.length>1){
        const a = positions[connected[connected.length-2]];
        const b = positions[connected[connected.length-1]];
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', a[0]); line.setAttribute('y1', a[1]); line.setAttribute('x2', b[0]); line.setAttribute('y2', b[1]);
        line.setAttribute('stroke','#ff6b6b'); line.setAttribute('stroke-width','2'); line.setAttribute('stroke-linecap','round');
        svg.appendChild(line);
      }
      if(connected.length===9){
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x','50'); t.setAttribute('y','50'); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle');
        t.setAttribute('font-size','8'); t.textContent='üíñ';
        svg.appendChild(t);
        setTimeout(()=>alert('Hearts Connected! üíñ'),400);
      }
    });
    grid.appendChild(d);
  }
}

/* hook up game buttons */
document.getElementById('startJig').addEventListener('click', ()=>{ startJigsaw(); });
document.getElementById('startMaze').addEventListener('click', ()=>{ startMaze(); });
document.getElementById('startDots').addEventListener('click', ()=>{ startDots(); });

/* ===========================
   Modal helpers (guide + generic)
   =========================== */
function openModal(html){
  modalContent.innerHTML = html;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}
closeModalBtn.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });

function openGuideModal(){
  openModal(`<h2 style="margin-top:0;color:#333">SOS Guide ‚Äî Hinglish</h2>
  <div class="small" style="color:#333">
    <p><strong>Step 1:</strong> Upar S ya O select karo.</p>
    <p><strong>Step 2:</strong> Grid mein kisi empty cell pe tap karo ‚Äî tumhara letter wahaan jayega.</p>
    <p><strong>Rule:</strong> Agar kisi horizontal, vertical ya diagonal line mein S-O-S ban jaata hai to usko ek point milega aur jo player ne woh move kiya usko extra turn milta hai.</p>
    <p><strong>Goal:</strong> AI se zyada points banao. 3 continuous wins se sari pages unlock hongi.</p>
    <p style="font-style:italic">Simple ‚Äî jaise pyaar: patience, surprises, aur thoda strategy. Good luck! üòò</p>
    <hr>
    <div><strong>Developer shortcuts</strong><br>Use the settings on the SOS card to change AI level, mistake chance, or skip SOS for testing.</div>
  </div>`);
}

/* Open dev menu */
document.getElementById('devMenu').addEventListener('click', ()=>{
  openModal(`<h3>Developer Controls</h3>
  <div class="small">
  <p><button id="devSkip" class="pill">Skip SOS (unlock)</button> <button id="devReset" class="pill">Reset site</button></p>
  <p>AI Level: <select id="devAi"><option>easy</option><option selected>medium</option><option>hard</option></select></p>
  </div>`);
  document.getElementById('devSkip').addEventListener('click', ()=>{
    streak = 3; updateProgress(); unlockAll(); modal.style.display='none';
  });
  document.getElementById('devReset').addEventListener('click', ()=>{
    location.reload();
  });
  document.getElementById('devAi').addEventListener('change', (e)=>{ aiLevelEl.value = e.target.value; CONFIG.AI_LEVEL = e.target.value; });
});

/* ===========================
   Initialize pages / UI
   =========================== */
function initPages(){
  // hide pages until unlocked
  pagesSection.style.display = 'none';
  bottomNav.style.display = 'none';
  // fill videos, timeline, polaroids
  renderVideoIndex();
  renderTimeline();
  renderPolaroids();
}
initPages();

/* render video index */
function renderVideoIndex(){
  const v = VIDEOS[videoIndex];
  vEmoji.textContent = v.emoji;
  vTitle.textContent = v.title;
  vMsg.textContent = v.msg;
  videoCounter.textContent = `${videoIndex+1} / ${VIDEOS.length}`;
}
prevVideo.addEventListener('click', ()=>{ videoIndex = (videoIndex-1 + VIDEOS.length) % VIDEOS.length; renderVideoIndex(); });
nextVideo.addEventListener('click', ()=>{ videoIndex = (videoIndex+1) % VIDEOS.length; renderVideoIndex(); });

/* render timeline and polaroids (done above) */
function renderTimeline(){
  timelineList.innerHTML = '';
  MILESTONES.forEach((m,i)=>{
    const el = document.createElement('div'); el.className='milestone';
    el.innerHTML = `<div class="dot">${m.emoji}</div><div><div style="font-weight:800">${m.title}</div><div class="small">${m.desc}</div></div>`;
    timelineList.appendChild(el);
  });
}
function renderPolaroids(){
  polaroidGrid.innerHTML = '';
  POLAROIDS.forEach(p=>{
    const el = document.createElement('div'); el.className='polaroid';
    el.innerHTML = `<img src="${p.img}" alt="${p.title}"><div style="font-weight:800;margin-top:8px">${p.title}</div><div class="small">${p.desc}</div>`;
    el.addEventListener('click', ()=>openModal(`<img src="${p.img}" style="width:100%;aspect-ratio:9/16;border-radius:8px"><h3 style="margin:12px 0 6px">${p.title}</h3><p>${p.desc}</p>`));
    polaroidGrid.appendChild(el);
  });
}
renderTimeline();
renderPolaroids();

/* ===========================
   Final small helpers / start
   =========================== */
updateScoreDisplay();
updateProgress();

/* expose some functions to window for debugging (optional) */
window._debug = {
  sos: ()=>sosBoard,
  resetRound,
  pickAIMove
};
</script>
</body>
</html>
